name: bump-deps

on:
  workflow_call:
    inputs:
      pre-release-pkg:
        description: >-
          Temporary flag for Flux 2.8: use the flux/v2.8.x pkg branch for main branches
          because the pkg release branch was cut before the Flux distribution release.
          Remove this input once Flux 2.8.0 is released.
        required: false
        default: false
        type: boolean
    secrets:
      github-token:
        description: 'GitHub token with contents and pull-requests write permissions'
        required: true

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.github-token }}
          fetch-depth: 0
          persist-credentials: false
      - name: Checkout fluxcd/pkg
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: fluxcd/pkg
          ref: cmd-bump
          path: fluxcd-pkg
      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod
          cache: false
      - name: Build flux-tools
        run: |
          make flux-tools
          mkdir -p ../bin
          cp bin/flux-tools ../bin/
        working-directory: fluxcd-pkg
      - name: Remove fluxcd/pkg clone
        run: rm -rf fluxcd-pkg
      - name: Run bump
        run: ./bin/flux-tools bump ${{ inputs.pre-release-pkg && '--pre-release-pkg' || '' }}
      - name: Tidy
        id: tidy
        run: make tidy
        continue-on-error: true
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ secrets.github-token }}
          commit-message: Update fluxcd/pkg dependencies
          committer: GitHub <noreply@github.com>
          signoff: true
          branch: update-pkg-deps/${{ github.ref_name }}
          title: Update fluxcd/pkg dependencies
          body: |
            Automated `fluxcd/pkg` dependency update for `${{ github.ref_name }}`.
            ${{ steps.tidy.outcome == 'failure' && '⚠️ `make tidy` failed, possibly due to breaking changes in the Go modules deps.' || '' }}

            Generated by: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
